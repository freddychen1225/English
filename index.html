<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echo Speak è‹±èªæ•™ç·´ V1.1</title>
    <style>
        :root {
            --primary: #54a0ff;
            --user-bg: #c8d6e5;
            --ai-bg: #feca57;
            --bg: #222f3e;
            --text: #c8d6e5;
            --word-tag: #ff9ff3;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 { margin-bottom: 5px; color: var(--primary); }
        .subtitle { font-size: 0.9rem; color: #8395a7; margin-bottom: 20px; }

        /* é¸å–®é é¢ */
        #menu-page { width: 100%; max-width: 600px; }
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .scenario-btn {
            background: #341f97; color: white; border: none;
            padding: 20px; border-radius: 15px; font-size: 1rem;
            cursor: pointer; display: flex; flex-direction: column; align-items: center;
            transition: 0.2s;
        }
        .scenario-btn:active { transform: scale(0.95); }
        .emoji { font-size: 2rem; margin-bottom: 5px; }
        .tag-label { font-size: 0.7rem; background: #ff6b6b; padding: 2px 6px; border-radius: 4px; margin-top: 5px; }

        /* ç·´ç¿’é é¢ */
        #practice-page { display: none; width: 100%; max-width: 500px; flex-direction: column; align-items: center; }
        
        .chat-box {
            width: 100%; background: rgba(255,255,255,0.1);
            border-radius: 20px; padding: 20px; margin-bottom: 10px;
            min-height: 180px; display: flex; flex-direction: column; justify-content: center;
            position: relative;
        }

        .role-label { font-size: 0.8rem; font-weight: bold; margin-bottom: 5px; color: #8395a7; }
        .text-content { font-size: 1.4rem; font-weight: bold; line-height: 1.4; margin-bottom: 10px; }
        .translation { font-size: 1rem; color: #8395a7; margin-bottom: 10px; font-style: italic; }
        
        .ai-text { color: var(--ai-bg); }
        .user-text { color: var(--primary); }

        /* å–®å­—å€ */
        .keywords-area {
            width: 100%; display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;
        }
        .word-btn {
            background: transparent; border: 1px solid var(--word-tag); color: var(--word-tag);
            padding: 5px 12px; border-radius: 20px; cursor: pointer; font-size: 0.9rem;
        }
        .word-btn:hover { background: var(--word-tag); color: #222; }
        
        .word-detail {
            width: 100%; background: #2e3c4e; border-radius: 10px; padding: 10px;
            margin-bottom: 15px; display: none; text-align: center; border-left: 4px solid var(--word-tag);
        }
        .kk-phonetic { color: #feca57; font-family: "Arial", sans-serif; margin: 0 10px; }

        /* æ§åˆ¶å€ */
        .controls { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        
        .btn-group { display: flex; gap: 20px; align-items: center; }

        .action-btn {
            width: 70px; height: 70px; border-radius: 50%; border: none;
            font-size: 1.8rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: 0.2s;
        }
        .play-btn { background: var(--ai-bg); color: #222; }
        .mic-btn { background: var(--primary); color: white; display: none; } /* é è¨­éš±è— */
        .mic-btn.listening { background: #ff6b6b; animation: pulse 1s infinite; }
        
        .next-btn {
            background: transparent; border: 2px solid #8395a7; color: #8395a7;
            padding: 10px 30px; border-radius: 30px; cursor: pointer; font-weight: bold;
        }

        .result-area {
            margin-top: 10px; padding: 10px; width: 100%; text-align: center;
            background: rgba(0,0,0,0.2); border-radius: 10px; min-height: 50px;
            color: #1dd1a1; font-size: 1.1rem;
        }

        .back-btn { position: absolute; top: 20px; left: 20px; background: none; border: none; color: #8395a7; font-size: 1.5rem; cursor: pointer; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

    </style>
</head>
<body>

    <div id="menu-page">
        <h1>Echo Speak V1.1</h1>
        <div class="subtitle">ç”Ÿæ´»æƒ…å¢ƒå£èªªæ•™ç·´</div>
        <div class="grid" id="scenario-grid"></div>
    </div>

    <div id="practice-page">
        <button class="back-btn" onclick="goHome()">â¬…ï¸</button>
        <h2 id="scenario-title" style="margin-top: 0;"></h2>
        
        <div class="chat-box">
            <div class="role-label" id="role-label">AI Teacher</div>
            <div class="text-content" id="display-text">...</div>
            <div class="translation" id="translation-text">...</div>
        </div>

        <!-- å–®å­—æŒ‰éˆ•å€ -->
        <div class="keywords-area" id="keywords-area"></div>
        <!-- å–®å­—è©³æƒ…é¡¯ç¤º -->
        <div class="word-detail" id="word-detail"></div>

        <div class="controls">
            <div class="btn-group">
                <!-- æ’­æ”¾æŒ‰éˆ• (User/AI é€šç”¨) -->
                <button class="action-btn play-btn" id="play-btn" onclick="speakText()">ğŸ”Š</button>
                
                <!-- éŒ„éŸ³æŒ‰éˆ• (User å°ˆç”¨) -->
                <button class="action-btn mic-btn" id="mic-btn" onclick="toggleMic()">ğŸ¤</button>
            </div>
            
            <!-- è¾¨è­˜çµæœ -->
            <div class="result-area" id="result-text">...</div>

            <button class="next-btn" onclick="nextLine()">Next Line â¡ï¸</button>
        </div>
    </div>

    <script>
        // --- 10å¤§æƒ…å¢ƒåŠ‡æœ¬ (å‰å…©å€‹åŒ…å« keywords) ---
        const scenarios = [
            {
                title: "Coffee Shop", emoji: "â˜•", hasKeywords: true,
                dialogs: [
                    { 
                        role: "AI", text: "Hi, are you ready to order?", trans: "å—¨ï¼Œæº–å‚™å¥½é»é¤äº†å—ï¼Ÿ",
                        keywords: [{w:"order", m:"é»é¤", k:"/ËˆÉ”ËrdÉ™r/"}, {w:"ready", m:"æº–å‚™å¥½", k:"/Ëˆredi/"}]
                    },
                    { 
                        role: "User", text: "Yes, I would like a hot latte, please.", trans: "æ˜¯çš„ï¼Œæˆ‘æƒ³è¦ä¸€æ¯ç†±æ‹¿éµã€‚",
                        keywords: [{w:"latte", m:"æ‹¿éµ", k:"/ËˆlÉ‘ËteÉª/"}, {w:"would like", m:"æƒ³è¦(ç¦®è²Œ)", k:"/wÊŠd laÉªk/"}]
                    },
                    { 
                        role: "AI", text: "Sure. What size would you like?", trans: "æ²’å•é¡Œï¼Œæƒ³è¦ä»€éº¼å°ºå¯¸ï¼Ÿ",
                        keywords: [{w:"size", m:"å°ºå¯¸", k:"/saÉªz/"}]
                    },
                    { 
                        role: "User", text: "Medium size, please.", trans: "ä¸­æ¯ï¼Œè¬è¬ã€‚",
                        keywords: [{w:"medium", m:"ä¸­æ¯ï¼›ä¸­ç­‰çš„", k:"/ËˆmiËdiÉ™m/"}]
                    }
                ]
            },
            {
                title: "Restaurant", emoji: "ğŸ”", hasKeywords: true,
                dialogs: [
                    { 
                        role: "AI", text: "Welcome! Do you have a reservation?", trans: "æ­¡è¿å…‰è‡¨ï¼è«‹å•æœ‰è¨‚ä½å—ï¼Ÿ",
                        keywords: [{w:"reservation", m:"é ç´„ï¼›è¨‚ä½", k:"/ËŒrezÉ™rËˆveÉªÊƒn/"}]
                    },
                    { 
                        role: "User", text: "No, I don't. Do you have a table for two?", trans: "æ²’æœ‰ã€‚è«‹å•æœ‰å…©äººçš„ä½å­å—ï¼Ÿ",
                        keywords: [{w:"table", m:"æ¡Œå­", k:"/ËˆteÉªbl/"}]
                    },
                    { 
                        role: "AI", text: "Yes, right this way. Here is the menu.", trans: "æœ‰çš„ï¼Œé€™é‚Šè«‹ã€‚é€™æ˜¯èœå–®ã€‚",
                        keywords: [{w:"menu", m:"èœå–®", k:"/ËˆmenjuË/"}, {w:"right this way", m:"é€™é‚Šè«‹", k:"phr."}]
                    }
                ]
            },
            { title: "Airport Check-in", emoji: "âœˆï¸", dialogs: [{ role: "AI", text: "Passport please.", trans: "è«‹å‡ºç¤ºè­·ç…§ã€‚" }] },
            { title: "On the Plane", emoji: "ğŸ±", dialogs: [{ role: "AI", text: "Chicken or Beef?", trans: "é›è‚‰æˆ–ç‰›è‚‰ï¼Ÿ" }] },
            { title: "Immigration", emoji: "ğŸ›‚", dialogs: [{ role: "AI", text: "Purpose of visit?", trans: "å…¥å¢ƒç›®çš„ï¼Ÿ" }] },
            { title: "Hotel Check-in", emoji: "ğŸ¨", dialogs: [{ role: "AI", text: "Checking in?", trans: "è¾¦ç†å…¥ä½å—ï¼Ÿ" }] },
            { title: "Supermarket", emoji: "ğŸ›’", dialogs: [{ role: "User", text: "Where is the milk?", trans: "ç‰›å¥¶åœ¨å“ªï¼Ÿ" }] },
            { title: "Asking Directions", emoji: "ğŸ—ºï¸", dialogs: [{ role: "User", text: "Where is the station?", trans: "è»Šç«™æ€éº¼èµ°ï¼Ÿ" }] },
            { title: "Shopping", emoji: "ğŸ‘•", dialogs: [{ role: "User", text: "Can I try this on?", trans: "å¯ä»¥è©¦ç©¿å—ï¼Ÿ" }] },
            { title: "Taking a Taxi", emoji: "ğŸš•", dialogs: [{ role: "User", text: "To the Hilton, please.", trans: "å»å¸Œçˆ¾é “é£¯åº—ã€‚" }] }
        ];

        // --- ç¨‹å¼é‚è¼¯ ---
        let currentScenario = null;
        let currentLineIndex = 0;
        let recognition;
        let isListening = false;

        window.onload = function() {
            const grid = document.getElementById('scenario-grid');
            scenarios.forEach((s, index) => {
                const btn = document.createElement('button');
                btn.className = 'scenario-btn';
                // å¦‚æœæœ‰å–®å­—åŠŸèƒ½ï¼ŒåŠ å€‹å°æ¨™ç±¤
                let tag = s.hasKeywords ? '<div class="tag-label">å«å–®å­—å¡</div>' : '';
                btn.innerHTML = `<div class="emoji">${s.emoji}</div><div>${s.title}</div>${tag}`;
                btn.onclick = () => startScenario(index);
                grid.appendChild(btn);
            });
            initSpeech();
        };

        function initSpeech() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = 'en-US';
                recognition.onresult = function(event) {
                    let transcript = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        transcript += event.results[i][0].transcript;
                    }
                    document.getElementById('result-text').innerText = transcript;
                };
                recognition.onend = function() {
                    isListening = false;
                    document.getElementById('mic-btn').classList.remove('listening');
                };
            } else {
                alert("è«‹ä½¿ç”¨ Chrome æˆ– Safari ä»¥æ”¯æ´èªéŸ³åŠŸèƒ½ã€‚");
            }
        }

        function startScenario(index) {
            currentScenario = scenarios[index];
            currentLineIndex = 0;
            document.getElementById('menu-page').style.display = 'none';
            document.getElementById('practice-page').style.display = 'flex';
            document.getElementById('scenario-title').innerText = currentScenario.emoji + " " + currentScenario.title;
            loadLine();
        }

        function loadLine() {
            // ç¢ºä¿è³‡æ–™çµæ§‹å®Œæ•´ (é˜²æ­¢å¾Œé¢æ²’æ“´å……çš„æƒ…å¢ƒå ±éŒ¯)
            if (!currentScenario.dialogs[currentLineIndex]) {
                // è‹¥è©²æƒ…å¢ƒåªæœ‰ä¸€è¡Œç°¡å–®è³‡æ–™ï¼Œé€™è£¡åšå€‹é˜²å‘†
                currentScenario.dialogs = [{ role: "System", text: "æ›´å¤šå…§å®¹å»ºç½®ä¸­...", trans: "Coming Soon..." }];
            }

            const line = currentScenario.dialogs[currentLineIndex];
            const roleLabel = document.getElementById('role-label');
            const displayText = document.getElementById('display-text');
            const transText = document.getElementById('translation-text');
            const playBtn = document.getElementById('play-btn');
            const micBtn = document.getElementById('mic-btn');
            const resultText = document.getElementById('result-text');
            const kwArea = document.getElementById('keywords-area');
            const wordDetail = document.getElementById('word-detail');

            roleLabel.innerText = line.role;
            displayText.innerText = line.text;
            transText.innerText = line.trans;
            resultText.innerText = "...";
            wordDetail.style.display = 'none'; // éš±è—å–®å­—è§£é‡‹

            // 1. æ¸²æŸ“å–®å­—å¡
            kwArea.innerHTML = "";
            if (line.keywords) {
                line.keywords.forEach(k => {
                    const kBtn = document.createElement('button');
                    kBtn.className = 'word-btn';
                    kBtn.innerText = k.w;
                    kBtn.onclick = () => showWordInfo(k);
                    kwArea.appendChild(kBtn);
                });
            }

            // 2. è§’è‰² UI åˆ‡æ›
            // ç„¡è«–æ˜¯ AI æˆ– Userï¼Œç¾åœ¨éƒ½æœ‰ Play æŒ‰éˆ• (Feature Request #1)
            if (line.role === 'AI') {
                roleLabel.style.color = '#feca57';
                displayText.className = 'text-content ai-text';
                playBtn.style.display = 'flex';
                micBtn.style.display = 'none'; // AI å›åˆä¸ç”¨éŒ„éŸ³
            } else {
                roleLabel.style.color = '#54a0ff';
                displayText.className = 'text-content user-text';
                playBtn.style.display = 'flex'; // User å›åˆä¹Ÿå¯ä»¥è½ç¤ºç¯„ç™¼éŸ³
                micBtn.style.display = 'flex';
            }
        }

        function showWordInfo(k) {
            const detail = document.getElementById('word-detail');
            detail.style.display = 'block';
            detail.innerHTML = `
                <div style="font-size:1.2rem; font-weight:bold; color:#fff;">${k.w}</div>
                <div style="margin:5px 0;">
                    <span class="kk-phonetic">[ ${k.k} ]</span>
                    <span style="color:#ccc;">${k.m}</span>
                </div>
            `;
        }

        function speakText() {
            const text = currentScenario.dialogs[currentLineIndex].text;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 0.9; 
            window.speechSynthesis.speak(utterance);
        }

        function toggleMic() {
            if (!recognition) return;
            if (isListening) {
                recognition.stop();
                isListening = false;
            } else {
                recognition.start();
                isListening = true;
                document.getElementById('mic-btn').classList.add('listening');
                document.getElementById('result-text').innerText = "Listening...";
            }
        }

        function nextLine() {
            currentLineIndex++;
            if (currentLineIndex < currentScenario.dialogs.length) {
                loadLine();
            } else {
                if(confirm("å®Œæˆå°è©±ï¼è¦å†ç·´ä¸€æ¬¡å—ï¼Ÿ\n(æŒ‰å–æ¶ˆå›é¦–é )")) {
                    currentLineIndex = 0;
                    loadLine();
                } else {
                    goHome();
                }
            }
        }

        function goHome() {
            document.getElementById('practice-page').style.display = 'none';
            document.getElementById('menu-page').style.display = 'block';
            window.speechSynthesis.cancel();
        }
    </script>
</body>
</html>
